{% extends "base.html" %}
{% load static %}

{% block content %}
<main class="container py-4">
  <div class="d-flex justify-content-between align-items-start align-items-md-center flex-column flex-md-row mb-3">
    <div>
      <h2 class="h4 m-0">
        Products{% if selected_category %} — {{ selected_category }}{% endif %}
      </h2>
      {% if user.is_authenticated and last_login %}
        <p class="text-muted small mb-0">Last login: {{ last_login }}</p>
      {% endif %}
    </div>
    <div class="mt-3 mt-md-0 d-flex align-items-center">
      <span class="text-muted small me-3">Total: {{ total_products }}</span>
      <button id="btn-refresh" class="btn btn-outline-secondary me-2" type="button">Refresh</button>
      <a class="btn btn-primary" href="{% url 'main:add_product' %}">Add</a>
    </div>
  </div>

  {% if products %}
    <div class="row g-3" data-server-grid>
      {% for p in products %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="card h-100 shadow-sm">
            {% if p.thumbnail %}
              <img src="{{ p.thumbnail }}" class="card-img-top" alt="{{ p.name }}">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between mb-2">
                <h5 class="card-title mb-0">{{ p.name }}</h5>
                {% if p.is_featured %}
                  <span class="badge badge-featured">Featured</span>
                {% endif %}
              </div>
              <p class="card-text text-muted small flex-grow-1">{{ p.description|truncatechars:120 }}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge text-bg-secondary">{{ p.category }}</span>
                <span class="price">Rp{{ p.price }}</span>
              </div>
              <div class="mt-auto">
                <a class="btn btn-outline-secondary btn-sm" href="{% url 'main:product_detail' pk=p.pk %}">Detail</a>
                {% if request.user.is_authenticated and p.user == request.user %}
                  <a class="btn btn-outline-primary btn-sm ms-1" href="{% url 'main:product_edit' pk=p.pk %}">Edit</a>
                  <form method="post" action="{% url 'main:product_delete' pk=p.pk %}" class="d-inline" onsubmit="return confirm('Delete this product?');">
                    {% csrf_token %}
                    <button class="btn btn-outline-danger btn-sm ms-1" type="submit">Delete</button>
                  </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info" data-server-empty>
      No products yet.
    </div>
  {% endif %}

  <!-- AJAX containers (initially hidden) -->
  <div id="product-loading" class="text-center py-5 d-none">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <div class="small text-muted mt-2">Loading products…</div>
  </div>
  <div id="product-error" class="alert alert-danger d-none"></div>
  <div id="product-empty" class="alert alert-info d-none">No products yet.</div>
  <div id="product-grid" class="row g-3 d-none"></div>

  <script>
    // Read query param (?category=...)
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // DOM nodes
    const btnRefresh    = document.getElementById("btn-refresh");
    const elLoading     = document.getElementById("product-loading");
    const elError       = document.getElementById("product-error");
    const elEmpty       = document.getElementById("product-empty");
    const elGrid        = document.getElementById("product-grid");
    const serverGrid    = document.querySelector("[data-server-grid]");
    const serverEmpty   = document.querySelector("[data-server-empty]");

    function show(el) { el && el.classList.remove("d-none"); }
    function hide(el) { el && el.classList.add("d-none"); }

    function productCardHTML(p) {
      const badge = p.is_featured ? '<span class="badge badge-featured">Featured</span>' : '';
      const price = `Rp${p.price}`;
      const thumb = p.thumbnail ? `<img src="${p.thumbnail}" class="card-img-top" alt="${p.name}">` : "";
      const category = p.category ? `<span class="badge text-bg-secondary">${p.category}</span>` : "";
      const editBtn = p.urls.edit ? `<a class="btn btn-outline-primary btn-sm" href="${p.urls.edit}">Edit</a>` : "";
      const deleteBtn = p.urls.delete ? `
        <form method="post" action="${p.urls.delete}" class="d-inline ms-2">
          <input type="hidden" name="csrfmiddlewaretoken" value="${(document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[]).pop()||''}">
          <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
        </form>` : "";

      return `
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="card h-100 shadow-sm">
            ${thumb}
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between mb-2">
                <h5 class="card-title mb-0">${p.name}</h5>
                ${badge}
              </div>
              <p class="card-text text-muted small flex-grow-1">${(p.description || "").slice(0,120)}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                ${category}
                <span class="price">${price}</span>
              </div>
              <div class="d-flex">
                <a class="btn btn-outline-secondary btn-sm" href="${p.urls.detail}">Detail</a>
                ${editBtn}
                ${deleteBtn}
              </div>
            </div>
          </div>
        </div>`;
    }

    async function loadProducts() {
      const category = getQueryParam("category");
      const url = new URL("{% url 'main:api_product_list' %}", window.location.origin);
      if (category) url.searchParams.set("category", category);

      // hide server-rendered blocks when AJAX runs
      hide(serverGrid);
      hide(serverEmpty);

      // show loading
      hide(elError); hide(elEmpty); hide(elGrid);
      show(elLoading);

      try {
        const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const products = Array.isArray(data.products) ? data.products : [];

        // render
        elGrid.innerHTML = products.map(productCardHTML).join("");
        hide(elLoading);
        if (products.length === 0) {
          show(elEmpty);
        } else {
          show(elGrid);
        }
      } catch (err) {
        hide(elLoading); hide(elGrid); hide(elEmpty);
        elError.textContent = "Failed to load products. Please try again.";
        show(elError);
        console.error(err);
      }
    }

    // Wire up refresh and initial load
    if (btnRefresh) btnRefresh.addEventListener("click", loadProducts);
    document.addEventListener("DOMContentLoaded", loadProducts);
  </script>
</main>
{% endblock %}