{% extends "base.html" %}
{% load static %}

{% block content %}
<main class="container py-4">
  <div class="d-flex justify-content-between align-items-start align-items-md-center flex-column flex-md-row mb-3">
    <div>
      <h2 class="h4 m-0">
        Products{% if selected_category %} — {{ selected_category }}{% endif %}
      </h2>
      {% if user.is_authenticated and last_login %}
        <p class="text-muted small mb-0">Last login: {{ last_login }}</p>
      {% endif %}
    </div>
    <div class="mt-3 mt-md-0 d-flex align-items-center">
      <span class="text-muted small me-3">Total: {{ total_products }}</span>
      <button id="btn-refresh" class="btn btn-outline-secondary me-2" type="button">Refresh</button>
      <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalAdd">Add</button>
    </div>
  </div>

  {# Server-rendered fallback (no-JS) #}
  {% if products %}
    <div class="row g-3" data-server-grid>
      {% for p in products %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3" data-pk="{{ p.pk }}">
          <div class="card h-100 shadow-sm">
            {% if p.thumbnail %}
              <img src="{{ p.thumbnail }}" class="card-img-top" alt="{{ p.name }}">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between mb-2">
                <h5 class="card-title mb-0">{{ p.name }}</h5>
                {% if p.is_featured %}
                  <span class="badge badge-featured">Featured</span>
                {% endif %}
              </div>
              <p class="card-text text-muted small flex-grow-1">{{ p.description|truncatechars:120 }}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge text-bg-secondary">{{ p.category }}</span>
                <span class="price">Rp{{ p.price }}</span>
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary btn-sm" href="{% url 'main:product_detail' pk=p.pk %}">Detail</a>
                {% if request.user.is_authenticated and p.user == request.user %}
                  <button class="btn btn-outline-primary btn-sm btn-edit" data-pk="{{ p.pk }}">Edit</button>
                  <button class="btn btn-outline-danger btn-sm btn-delete" data-pk="{{ p.pk }}">Delete</button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info mb-4" data-server-empty>
      No products yet.
    </div>
  {% endif %}

  <!-- Dynamic AJAX grid (initially hidden, will replace server fallback) -->
  <div id="product-loading" class="text-center py-5 d-none">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <div class="small text-muted mt-2">Loading products…</div>
  </div>
  <div id="product-error" class="alert alert-danger d-none"></div>
  <div id="product-empty" class="alert alert-info d-none">No products yet.</div>
  <div id="productGrid" class="row g-3 d-none"></div>

  <!-- Add (Create) Modal -->
  <div class="modal fade" id="modalAdd" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addProductForm" class="modal-content" method="post" action="{% url 'main:add_product' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="addErrors" class="alert alert-danger d-none"></div>
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input name="name" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Price</label>
            <input name="price" type="number" min="0" step="1" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Thumbnail (URL)</label>
            <input name="thumbnail" type="url" class="form-control" placeholder="https://...">
          </div>
          <div class="mb-2">
            <label class="form-label">Category</label>
            <input name="category" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-check">
            <input name="is_featured" id="add_is_featured" type="checkbox" class="form-check-input">
            <label for="add_is_featured" class="form-check-label">Featured</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnAddSave" class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="modalEdit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editProductForm" class="modal-content" method="post" action="#">
        {% csrf_token %}
        <input type="hidden" id="edit_pk" name="pk">
        <div class="modal-header">
          <h5 class="modal-title">Edit Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="editErrors" class="alert alert-danger d-none"></div>
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input id="edit_name" name="name" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Price</label>
            <input id="edit_price" name="price" type="number" min="0" step="1" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Thumbnail (URL)</label>
            <input id="edit_thumbnail" name="thumbnail" type="url" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Category</label>
            <input id="edit_category" name="category" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Description</label>
            <textarea id="edit_description" name="description" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-check">
            <input id="edit_is_featured" name="is_featured" type="checkbox" class="form-check-input">
            <label for="edit_is_featured" class="form-check-label">Featured</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnEditSave" class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete confirmation uses native confirm() in script; no dedicated modal required here -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Expose loadProducts globally so base nav helpers can call it if needed
      window.loadProducts = loadProducts;

      const refreshBtn = document.getElementById('btn-refresh');
      const loadingEl = document.getElementById('product-loading');
      const errorEl = document.getElementById('product-error');
      const emptyEl = document.getElementById('product-empty');
      const ajaxGrid = document.getElementById('productGrid');
      const serverGrid = document.querySelector('[data-server-grid]');
      const serverEmpty = document.querySelector('[data-server-empty]');

      const addForm = document.getElementById('addProductForm');
      const addBtn = document.getElementById('btnAddSave');
      const editForm = document.getElementById('editProductForm');
      const editBtn = document.getElementById('btnEditSave');

      function show(el){ el && el.classList.remove('d-none'); }
      function hide(el){ el && el.classList.add('d-none'); }

      function cardHTML(p) {
        return `
        <div class="col-12 col-sm-6 col-md-4 col-lg-3" data-pk="${p.pk}">
          <div class="card h-100 shadow-sm">
            ${p.thumbnail ? `<img src="${p.thumbnail}" class="card-img-top" alt="${p.name}">` : ""}
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between mb-2">
                <h5 class="card-title mb-0">${p.name}</h5>
                ${p.is_featured ? `<span class="badge badge-featured">Featured</span>` : ""}
              </div>
              <p class="card-text text-muted small flex-grow-1">${(p.description || "").slice(0,120)}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge text-bg-secondary">${p.category || ''}</span>
                <span class="price">Rp${p.price}</span>
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary btn-sm" href="${p.detail_url}">Detail</a>
                <button class="btn btn-outline-primary btn-sm btn-edit" data-pk="${p.pk}">Edit</button>
                <button class="btn btn-outline-danger btn-sm btn-delete" data-pk="${p.pk}">Delete</button>
              </div>
            </div>
          </div>
        </div>`;
      }

      function getQueryParam(name){
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      async function loadProducts() {
        const category = getQueryParam('category');
        const url = new URL("{% url 'main:api_product_list' %}", window.location.origin);
        if (category) url.searchParams.set("category", category);

        // Hide server fallback when AJAX active
        hide(serverGrid);
        hide(serverEmpty);

        hide(errorEl); hide(emptyEl); hide(ajaxGrid);
        show(loadingEl);

        try {
          const data = await jsonFetch(url.toString());
          const list = data.products || [];
          ajaxGrid.innerHTML = list.map(cardHTML).join('');
          hide(loadingEl);
          if (!list.length) {
            show(emptyEl);
          } else {
            show(ajaxGrid);
          }
        } catch (err) {
          hide(loadingEl); hide(ajaxGrid); hide(emptyEl);
          errorEl.textContent = "Failed to load products: " + err.message;
          show(errorEl);
          showToast("Load products failed");
        }
      }

      if (refreshBtn) refreshBtn.addEventListener('click', loadProducts);

      // ADD
      if (addForm && addBtn) {
        addForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          addBtn.disabled = true;
            const originalText = addBtn.textContent;
          addBtn.textContent = 'Saving...';
          const formData = new FormData(addForm);
          // Mark this as AJAX
          try {
            const resp = await fetch(addForm.action, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN },
              body: formData
            });
            const data = await resp.json();
            if (!resp.ok || !data.ok) {
              showToast('Add failed', 'danger');
              if (data.errors) console.error(data.errors);
            } else {
              // Insert new card at start
              ajaxGrid.insertAdjacentHTML('afterbegin', cardHTML(data.product));
              addForm.reset();
              bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide();
              showToast('Product added', 'success');
              hide(document.querySelector('[data-server-grid]'));
              hide(document.querySelector('[data-server-empty]'));
              show(ajaxGrid);
            }
          } catch (err) {
            showToast('Network error while adding', 'danger');
          } finally {
            addBtn.disabled = false;
            addBtn.textContent = originalText;
          }
        });
      }

      // EDIT open (prefill)
      document.body.addEventListener('click', async (e) => {
        const btn = e.target.closest('.btn-edit');
        if (!btn) return;
        const pk = btn.dataset.pk;
        try {
          // Use existing JSON detail (returns a serialized array)
          const res = await fetch(`/products/json/${pk}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
          const raw = await res.json();
          // raw is a Django serialization list; adapt:
          let obj = raw;
          if (Array.isArray(raw) && raw.length && raw[0].fields) {
            const f = raw[0].fields;
            obj = {
              pk: raw[0].pk,
              name: f.name,
              price: f.price,
              description: f.description,
              thumbnail: f.thumbnail,
              category: f.category,
              is_featured: f.is_featured
            };
          }
          document.getElementById('edit_pk').value = obj.pk || pk;
          document.getElementById('edit_name').value = obj.name || '';
          document.getElementById('edit_price').value = obj.price ?? '';
          document.getElementById('edit_description').value = obj.description || '';
          document.getElementById('edit_thumbnail').value = obj.thumbnail || '';
          document.getElementById('edit_category').value = obj.category || '';
          document.getElementById('edit_is_featured').checked = !!obj.is_featured;

          // Set form action to edit URL
          editForm.action = `/products/${pk}/edit/`;

          new bootstrap.Modal(document.getElementById('modalEdit')).show();
        } catch (err) {
          showToast('Failed to load product: ' + err.message);
        }
      });

      // EDIT submit
      if (editForm && editBtn) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          editBtn.disabled = true;
          const originalText = editBtn.textContent;
          editBtn.textContent = 'Saving...';
          const pk = document.getElementById('edit_pk').value;
          const formData = new FormData(editForm);
          try {
            const resp = await fetch(editForm.action, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN },
              body: formData
            });
            const data = await resp.json();
            if (!resp.ok || !data.ok) {
              showToast('Update failed', 'danger');
              if (data.errors) console.error(data.errors);
            } else {
              const p = data.product;
              const card = ajaxGrid.querySelector(`[data-pk="${p.pk}"]`) ||
                           document.querySelector(`[data-pk="${p.pk}"]`);
              if (card) card.outerHTML = cardHTML(p);
              bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide();
              showToast('Product updated', 'success');
            }
          } catch (err) {
            showToast('Network error while updating', 'danger');
          } finally {
            editBtn.disabled = false;
            editBtn.textContent = originalText;
          }
        });
      }

      // DELETE
      document.body.addEventListener('click', async (e) => {
        const btn = e.target.closest('.btn-delete');
        if (!btn) return;
        const pk = btn.dataset.pk;
        if (!confirm('Delete this product?')) return;
        try {
          const resp = await fetch(`/products/${pk}/delete/`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN }
          });
          const data = await resp.json();
          if (!resp.ok || !data.ok) {
            showToast('Delete failed', 'danger');
          } else {
            const card = ajaxGrid.querySelector(`[data-pk="${pk}"]`) ||
                         document.querySelector(`[data-pk="${pk}"]`);
            if (card) card.remove();
            showToast('Product deleted', 'success');
            if (!ajaxGrid.querySelector('[data-pk]') && !document.querySelector('[data-server-grid] [data-pk]')) {
              show(emptyEl);
            }
          }
        } catch (err) {
            showToast('Network error while deleting', 'danger');
        }
      });

      // Initial load (replaces server-rendered fallback)
      loadProducts();
    });
  </script>
</main>
{% endblock %}